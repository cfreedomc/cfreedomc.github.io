---
title: MySQL系列-1-查询语句执行介绍
date: 2018-10-11
tags: mysql
---
![图片](http://pl5cg4rhb.bkt.clouddn.com/dubbo7page.png)
>本篇主要介绍MySQL中查询语句的执行流程,主要包含连接器,查询缓存,分析器,优化器,执行器;

<!-- more -->
# 一条sql查询语句是如何执行的
## mysql逻辑架构图
mysql主要可以分为Server层和存储引擎层这两层；
* Server层主要层包括连接器、查询缓存、分析器、优化器、执行器等，涵盖 MySql的大多数核心服务功能，以及所有的内置函数（如日期，时间，数学和加密函数等），所有跨存储引擎的功能都在这实现，比如存储过程，触发器，视图等;
* 存储引擎层负责数据的存储和提取，其架构模式是插件式的，支持InnoDB，MyISAM，Memory等多个存储引擎(InnoDB为默认引擎).

![图片](http://pl5cg4rhb.bkt.clouddn.com/mysql-1-1.png)
## Server层介绍
### 连接器
* 简介：
  * 连接器负责跟客户端建立连接,获取权限,维持和管理连接.
* 触发点:
  * 当触发于mysql数据库的连接时,会调用连接器如
```
mysql -h$ip -P$port -u$user -p
```
  * 细节:在完成经典tcp握手后,连接器就开始认证你的身份,身份认证主要有以下两点:
    * 用户名密码验证;
    * 通过权限表查出你拥有权限;
* 连接类型:
  * 短连接:每次执行完很少几次查询就断开连接,下次查询再重新建立;
  * 长连接:连接成功后,如果客户端持续请求,则一直使用同一个连接;
* 连接器思考:
  * 长连接一直保持,会造成连接对象长期占用内存,若不断开连接无法释放,处理方法:
    * 定期断开长连接;
    * mysql5.7及以上可以在执行较大操作后,执行mysql_reset_connection重新初始化连接资源(该情况无需重新验证连接信息);

### 查询缓存
* 简介:
  * 连接建立后,查询语句会执行第二步,查询缓存,将查询语句作为key,查询是否有对应value返回;
* 查询缓存思考:
  * 直接跳至思考,是因为不建议使用查询缓存功能,mysql8.0版本已经删除该功能,那为何不建议呢?
    * 因为查询缓存的缓存其实在mysql中会出现频繁更新情况,如果有对表出现更新操作,缓存就会失效,这会使缓存的命中率很低,估计只能试用某些业务静态表了;

### 分析器
* 简介:
  * 这是执行语句第三步,分析器负责解析SQL语句
* 执行内容:
  * 识别sql内容,分析是何种语句,表明,列名等对应;
  * 识别确定语句后,进行词法分析,分析语句是否满足mysql语法规范
* 错误举例:
```
mysql> elect * from t where ID=1;

ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'elect * from t where ID=1' at line 1
```

### 优化器
* 简介:
  * 这是执行语句第四部,在分析完sql语句后,决定如何执行sql,如索引选择等;
* 举例:
```
mysql> select * from t1 join t2 using(ID)  where t1.c=10 and t2.d=20;
```
  * 该语句先取t1的c=10的再操作接下来的,也可以先取t2中d=20的,虽然最后逻辑一样,但是由于操作顺序不一样其执行效率也不有不同;

### 执行器
* 简介:
  * 这是执行语句最后一步,开始执行语句,执行前要先判断目前连接是否有执行表权限;
* 举例:
```
mysql> select * from T where ID=10;
```
  1. 调用InnoDB引擎借口取这个表第一行,判断ID是否10,不是跳过,是则存在结果集中;
  2. 调用引擎接口取下一行,重复判断直至结束;
  3. 将结果集返回客户端
* 查看:
  * 可以通过慢查询日志rows_examined字段了解该语句执行过程中扫描了多少行(该值是执行器每次调用引擎获取数据行时累加);

