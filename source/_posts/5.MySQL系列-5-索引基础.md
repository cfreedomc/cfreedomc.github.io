---
title: MySQL系列-5-索引基础
date: 2018-10-31
tags: mysql
---
>本篇主要介绍MySQL中关于索引的底层结构以及InnoDB的索引基础概念;

<!-- more -->

## 索引的概念
### 索引的目的
为了提高数据查询的效率,像书的目录

### 索引的结构
索引的储存结构常见的有以下三种:**哈希表**,**有序数组**和**搜索树**
* 哈希表
  * 概念:
    * 是以键-值(key-value)存储数据的结构,只要输入key,就返回对应key的value值,哈希的思路就是把值放在数组里,用哈希函数把key换成一个确定的位置;但哈希函数在多个key可能返回同一个位置,这个时候在这个位置上就会拉去出一个链表;
  * 下图为以ID_card查找name的哈希结构的索引结构图

![图片](https://i.loli.net/2019/03/04/5c7d2d0cc7835.png)
  * 哈希结构优缺点
    * 优点:支持快速的增删
    * 缺点:结构**无序**,**区间查询速度很慢**(必须全部扫描)
  * 使用场景
    * **等值查询**,即直接"= v"的场景
* 有序数组
  * 概念:
    * 有序数组我们都很熟悉,就是将索引递增的存入数组中的结构
  * 如下图所示

![图片](https://i.loli.net/2019/03/04/5c7d2d379a558.png)
  * 有序数组的优缺点:
    * 优点:因为有序,所以可以快速的进行等值以及区间查询
    * 缺点:如果需要对数组进行改动,那么代价就很大,在数组中间插入记录则需挪动后面所有记录;
  * 使用场景:
    * 有序数组索引只适用于**静态存储引擎**
* 搜索树
  * 概念:
    * 二叉树的每个节点的左儿子小于父节点,父节点又小于右儿子
  * 下图为二叉树的结构

![图片](https://i.loli.net/2019/03/04/5c7d2d37adeef.png)
  * 搜索树的优缺点
    * 优点:,查询和更改都快
    * 缺点:二叉搜索树的由于索引不只要写入内存,还要写入磁盘,每一层都要写入磁盘交互,而磁盘读取数据库寻址需要10ms左右,所以对于很大数据量的表,用二叉树存储太慢,所以退而其次的使用多叉树的结构;
  * 使用场景
    * N叉树读写的性能优势以及适配磁盘的访问木事,基本广泛应用在数据库引擎;

---
## InnoDB索引模型
由于在Mysql中我们主要使用InnoDB作为主要的搜索引擎,所以以下都以InnoDB介绍
### B+树
B+树是二叉树的一种变形,其优势使得在一个内存页中可以存储更多的key,具体的B+树结构就不在这里展开了;

### InnoDB索引特点
InnoDB中索引类型主要会区分:**主键索引**以及**非主键索引**两种;
* 主键索引
  * 主键索引的叶子节点存放的是整行数据,被称为聚簇索引(clustered index)
* 非主键索引
  * 非主键索引叶子节点存放的是主键索引的值,所以也成为二级索引( secondary index)
* 举例:如现在有主键索引ID和非主键索引k,其结构如下图

![图片](https://i.loli.net/2019/03/04/5c7d2d37b0f98.png)
* 索引的流程
  * 由于如上图结构的存在,所以当我们使用k索引进行查询时,会先从k的索引树先查询到主键索引值,再通过主键索引查询到对应行数据(这个过程称之为**回表**)
  * 所以在应用中应该尽量使用主键查询;

### 索引的维护
* B+树问题
  * 由于B+树为了维持索引的有序性,每次插入新值都需要维护,如果插入的ID>current.Max直接在后面接索引就可以,但是如果出现插入的ID<current.Max时,就需要将所以大于插入值得索引值后移,在后移过程中可能出现当前索引页满了需要扩张的情况,那么这样开销就更为大了;
* 主键索引建议
  * 所以由于上面的问题,工作中会发现主键索引一般会用**int且自增**,这样的好处有两点
    * 永远在最后插入新数据,不用担心B+树的格外开销
    * 使用int时非主键索引的叶子节点存放的主键索引就小,自然占用空间就小
* 格外说明:
  * 所以什么时候会用业务字段作为索引,一般会满足以下两个条件
    * 只有一个索引
    * 该索引是唯一索引
  * 如果不满足以上条件,建议还是按照主键索引的玩法去做

### 索引实战
思考问题:直接删除非主键索引和删除主键索引有何问题?
* 解答:删除非主键索引没问题,但是删除主键索引会使整个表的索引都没用,本质就是会将整个表进行重建;


